<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClawWallet 签名</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <style>
        body { font-family: sans-serif; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; background: #f4f4f9; }
        .card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; width: 80%; }
        .loading-dots:after { content: ' .'; animation: dots 1s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { color: rgba(0,0,0,0); text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); } 40% { color: black; text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); } 60% { text-shadow: .25em 0 0 black, .5em 0 0 rgba(0,0,0,0); } 80%, 100% { text-shadow: .25em 0 0 black, .5em 0 0 black; } }
    </style>
</head>
<body>
    <div class="card">
        <h2 id="title">正在初始化钱包</h2>
        <p id="info" class="loading-dots">正在安全连接至 Telegram Wallet</p>
        <div id="ton-connect-button" style="display: none;"></div>
    </div>

    <script>
        const WebApp = window.Telegram.WebApp;
        WebApp.ready();

        // 1. 初始化 TON Connect
        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: 'https://clawwallet.vercel.app/tonconnect-manifest.json',
            buttonRootId: 'ton-connect-button'
        });

        async function initTransfer() {
            const params = new URLSearchParams(window.location.search);
            const to = params.get('to');
            const amount = params.get('amount');

            if (!to || !amount) {
                document.getElementById('info').innerText = "参数缺失";
                return;
            }

            // 如果钱包没连接，先让用户点击连接
            if (!tonConnectUI.connected) {
                document.getElementById('title').innerText = "请先连接钱包";
                document.getElementById('info').innerText = "点击下方按钮连接 Telegram Wallet";
                document.getElementById('ton-connect-button').style.display = 'block';
                return;
            }

            // 2. 构造转账消息
            const transaction = {
                validUntil: Math.floor(Date.now() / 1000) + 360,
                messages: [
                    {
                        address: to,
                        amount: (parseFloat(amount) * 1000000000).toString() // TON to nanoTON
                    }
                ]
            };

            try {
                document.getElementById('title').innerText = "等待签名";
                document.getElementById('info').innerText = "请在弹出的窗口中确认交易";
                
                // 3. 弹出 Telegram Wallet 原生签名框
                await tonConnectUI.sendTransaction(transaction);
                
                document.getElementById('title').innerText = "✅ 发送成功";
                document.getElementById('info').innerText = "交易已提交至区块链。";
                WebApp.HapticFeedback.notificationOccurred('success');
                
                setTimeout(() => WebApp.close(), 3000);
            } catch (e) {
                document.getElementById('title').innerText = "❌ 交易取消";
                document.getElementById('info').innerText = e.message || "您取消了签名";
            }
        }

        // 监听连接状态，一旦连接成功就触发转账
        tonConnectUI.onStatusChange(wallet => {
            if (wallet) initTransfer();
        });

        // 初始尝试
        initTransfer();
    </script>
</body>
</html>