<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>OpenClaw-Wallet</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    body {
      margin: 0;
      background: #efeff4;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .card {
      width: 100%;
      max-width: 400px;
      background: #fff;
      border-radius: 24px;
      padding: 24px;
      box-shadow: 0 8px 24px rgba(0,0,0,.05);
      text-align: center;
    }
    .amount {
      font-size: 40px;
      font-weight: 800;
      color: #2481cc;
    }
    .btn {
      margin-top: 16px;
      width: 100%;
      padding: 16px;
      border-radius: 14px;
      border: none;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      background: #2481cc;
      color: #fff;
    }
    .btn.success { background: #4caf50; }
    .hint {
      margin-top: 12px;
      font-size: 13px;
      color: #8e8e93;
    }
    .manual {
      display: none;
      margin-top: 12px;
      padding: 12px;
      border: 1px dashed #2481cc;
      border-radius: 12px;
      color: #2481cc;
      cursor: pointer;
      font-weight: 600;
    }
  </style>
</head>

<body>
<div class="card">
  <div id="title">åŠ è½½ä¸­...</div>
  <div class="amount">
    <span id="amt">0</span> <span id="sym">ETH</span>
  </div>
  <div id="addr" class="hint">---</div>

  <button id="btn" class="btn" disabled>å‡†å¤‡ä¸­...</button>
  <div id="manual" class="manual">ğŸ‘‰ æ‰‹åŠ¨è·³è½¬é’±åŒ…å®Œæˆç­¾å</div>
  <div id="status" class="hint">Ethereum Sepolia</div>
</div>

<script type="module">
  import { createWeb3Modal, defaultWagmiConfig } from 'https://esm.sh/@web3modal/wagmi@5'
  import { sepolia } from 'https://esm.sh/@wagmi/core/chains'
  import {
    reconnect,
    sendTransaction,
    writeContract,
    getAccount,
    watchAccount
  } from 'https://esm.sh/@wagmi/core'
  import { parseEther } from 'https://esm.sh/viem'

  const WebApp = window.Telegram.WebApp
  WebApp.ready()
  WebApp.expand()

  /* ---------------- å‚æ•° ---------------- */
  const p = new URLSearchParams(location.search)
  const to = p.get('to')
  const amount = p.get('amount') || '0'
  const symbol = p.get('symbol') || 'ETH'

  const value = parseEther(amount)

  /* ---------------- UI ---------------- */
  const title = document.getElementById('title')
  const amt = document.getElementById('amt')
  const sym = document.getElementById('sym')
  const addr = document.getElementById('addr')
  const btn = document.getElementById('btn')
  const manual = document.getElementById('manual')
  const status = document.getElementById('status')

  amt.innerText = amount
  sym.innerText = symbol
  addr.innerText = to || 'â€”'
  title.innerText = 'è½¬è´¦ç¡®è®¤'

  /* ---------------- Web3Modal ---------------- */
  const config = defaultWagmiConfig({
    chains: [sepolia],
    projectId: '3e32acd77b1e3fe41aa2fee70ba1bb21',
    metadata: {
      name: 'OpenClaw Wallet',
      description: 'Telegram Web3 Transfer',
      url: location.origin,
      icons: ['https://avatars.githubusercontent.com/u/37784886']
    }
  })

  const modal = createWeb3Modal({
    wagmiConfig: config,
    projectId: '3e32acd77b1e3fe41aa2fee70ba1bb21',
    defaultChain: sepolia
  })

  /* ---------------- å…³é”®ï¼šè·å–é’±åŒ… deeplink ---------------- */
  const getWalletLink = () => {
    const acc = getAccount(config)
    const provider = acc.connector?.getProvider?.()
    return provider?.session?.peer?.metadata?.url || null
  }

  /* ---------------- ä¸»é€»è¾‘ï¼ˆæ–¹æ¡ˆäºŒï¼‰ ---------------- */
  let processing = false

  const handleAction = async () => {
    const acc = getAccount(config)

    if (!acc.isConnected) {
      modal.open()
      return
    }

    if (processing) return
    processing = true

    try {
      status.innerText = 'è¯·æ±‚é’±åŒ…ç­¾åä¸­...'
      await sendTransaction(config, { to, value })

      WebApp.HapticFeedback.notificationOccurred('success')
      WebApp.close()
    } catch (e) {
      console.warn('TX failed, fallback openLink', e)

      status.innerText = 'Telegram é™åˆ¶è‡ªåŠ¨å”¤èµ·ï¼Œè¯·æ‰‹åŠ¨è·³è½¬é’±åŒ…'
      manual.style.display = 'block'

      const link = getWalletLink()
      if (link) {
        Telegram.WebApp.openLink(link, {
          try_instant_view: false
        })
      } else {
        WebApp.showAlert('æœªèƒ½è·å–é’±åŒ…é“¾æ¥ï¼Œè¯·æ‰‹åŠ¨æ‰“å¼€é’±åŒ… App')
      }
    } finally {
      processing = false
    }
  }

  /* ---------------- è´¦æˆ·ç›‘å¬ ---------------- */
  watchAccount(config, {
    onChange(acc) {
      if (acc.isConnected) {
        btn.innerText = 'ç¡®è®¤äº¤æ˜“'
        btn.classList.add('success')
        btn.disabled = false
        WebApp.MainButton.setText('ç¡®è®¤äº¤æ˜“').show().onClick(handleAction)
      } else {
        btn.innerText = 'è¿æ¥é’±åŒ…'
        btn.disabled = false
        WebApp.MainButton.hide()
      }
    }
  })

  reconnect(config)
  btn.onclick = handleAction
  manual.onclick = () => {
    const link = getWalletLink()
    if (link) {
      Telegram.WebApp.openLink(link, { try_instant_view: false })
    }
  }
</script>
</body>
</html>
